var w=Object.defineProperty;var f=Object.getOwnPropertySymbols;var v=Object.prototype.hasOwnProperty,b=Object.prototype.propertyIsEnumerable;var m=(r,e,t)=>e in r?w(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,h=(r,e)=>{for(var t in e||(e={}))v.call(e,t)&&m(r,t,e[t]);if(f)for(var t of f(e))b.call(e,t)&&m(r,t,e[t]);return r};var d=(r,e,t)=>new Promise((n,i)=>{var o=s=>{try{a(t.next(s))}catch(l){i(l)}},c=s=>{try{a(t.throw(s))}catch(l){i(l)}},a=s=>s.done?n(s.value):Promise.resolve(s.value).then(o,c);a((t=t.apply(r,e)).next())});function escapeHtml(r){return typeof r!="string"?"":r.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;").replace(/\//g,"&#x2F;")}function escapeUrl(r){if(typeof r!="string"||!r||r.trim()==="")return"#";try{return r.startsWith("#")?r:new URL(r).toString()}catch(e){return"#"}}function debounce(r,e,t=!1){let n;return function(...o){const c=()=>{n=null,t||r(...o)},a=t&&!n;clearTimeout(n),n=setTimeout(c,e),a&&r(...o)}}function throttle(r,e){let t;return function(){const n=arguments,i=this;t||(r.apply(i,n),t=!0,setTimeout(()=>t=!1,e))}}function deepClone(r){if(r===null||typeof r!="object")return r;if(r instanceof Date)return new Date(r.getTime());if(r instanceof Array)return r.map(e=>deepClone(e));if(typeof r=="object"){const e={};for(const t in r)r.hasOwnProperty(t)&&(e[t]=deepClone(r[t]));return e}}function generateId(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}function formatFileSize(r){if(r===0)return"0 Bytes";const e=1024,t=["Bytes","KB","MB","GB"],n=Math.floor(Math.log(r)/Math.log(e));return parseFloat((r/Math.pow(e,n)).toFixed(2))+" "+t[n]}function getDeviceType(){const r=window.innerWidth;return r<768?"mobile":r<1024?"tablet":"desktop"}const Storage={get(r,e=null){try{const t=localStorage.getItem(r);return t?JSON.parse(t):e}catch(t){return console.error("Storage get error:",t),e}},set(r,e){try{return localStorage.setItem(r,JSON.stringify(e)),!0}catch(t){return console.error("Storage set error:",t),!1}},remove(r){try{return localStorage.removeItem(r),!0}catch(e){return console.error("Storage remove error:",e),!1}},clear(){try{return localStorage.clear(),!0}catch(r){return console.error("Storage clear error:",r),!1}}},DOM={create(r,e={},t=[]){const n=document.createElement(r);return Object.entries(e).forEach(([i,o])=>{i==="className"?n.className=o:i==="innerHTML"?n.innerHTML=o:i==="textContent"?n.textContent=o:i.startsWith("data-")||i.startsWith("aria-")?n.setAttribute(i,o):i==="style"&&typeof o=="object"?Object.assign(n.style,o):i in n&&typeof n[i]!="function"?n[i]=o:n.setAttribute(i,o)}),t.forEach(i=>{i!=null&&(typeof i=="string"?n.appendChild(document.createTextNode(i)):i instanceof Node?n.appendChild(i):Array.isArray(i)&&i.forEach(o=>{typeof o=="string"?n.appendChild(document.createTextNode(o)):o instanceof Node&&n.appendChild(o)}))}),n},find(r,e=document){return e.querySelector(r)},findAll(r,e=document){return Array.from(e.querySelectorAll(r))},on(r,e,t,n={}){return r.addEventListener(e,t,n),()=>r.removeEventListener(e,t,n)},remove(r){r&&r.parentNode&&r.parentNode.removeChild(r)},show(r){r.style.display=""},hide(r){r.style.display="none"},toggle(r){r.style.display=r.style.display==="none"?"":"none"}},Animation={fadeIn(r,e=300){r.style.opacity=0,r.style.display="";let t=null;function n(i){t||(t=i);const o=i-t,c=Math.min(o/e,1);r.style.opacity=c,o<e&&requestAnimationFrame(n)}requestAnimationFrame(n)},fadeOut(r,e=300,t){let n=null;const i=parseFloat(window.getComputedStyle(r).opacity);function o(c){n||(n=c);const a=c-n,s=Math.max(i*(1-a/e),0);r.style.opacity=s,a<e?requestAnimationFrame(o):(r.style.display="none",t&&t())}requestAnimationFrame(o)}};window.Helpers={escapeHtml,escapeUrl,debounce,throttle,deepClone,generateId,formatFileSize,getDeviceType,Storage,DOM,Animation};class NotificationManager{constructor(){this.container=null,this.notifications=[],this.maxNotifications=5,this.defaultDuration=4e3,this.activeNotifications=new Set,this.init()}init(){this.container=document.createElement("div"),this.container.className="notification-container",this.container.style.cssText=`
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      pointer-events: none;
    `,document.body.appendChild(this.container)}show(e,t="info",n=this.defaultDuration){try{if(!e||typeof e!="string")return console.warn("Notification: Invalid message provided"),null;const i=`${t}_${e}_${Date.now()}`;if(this.activeNotifications.has(i))return console.log("Notification: Duplicate notification skipped:",e),null;const o=this.createNotification(i,e,t);return this.container.appendChild(o),this.notifications.push({id:i,element:o,type:t}),this.activeNotifications.add(i),this.limitNotifications(),requestAnimationFrame(()=>{o.classList.add("notification-show")}),n>0&&setTimeout(()=>{this.hide(i)},n),i}catch(i){return console.error("Notification show error:",i),null}}hide(e){try{const t=this.notifications.findIndex(i=>i.id===e);if(t===-1)return;const{element:n}=this.notifications[t];this.activeNotifications.delete(e),n.classList.add("notification-hide"),setTimeout(()=>{try{n&&n.parentNode&&n.parentNode.removeChild(n),this.notifications.splice(t,1)}catch(i){console.warn("Notification hide DOM removal error:",i)}},300)}catch(t){console.error("Notification hide error:",t)}}createNotification(e,t,n){const i=document.createElement("div");i.className=`notification notification-${n}`,i.dataset.id=e;const o={success:"‚úì",error:"‚úï",warning:"‚ö†",info:"‚Ñπ"};return i.innerHTML=`
      <div class="notification-icon">${o[n]||o.info}</div>
      <div class="notification-content">${t}</div>
      <button class="notification-close" onclick="NotificationUtils.hideStatic(${e})">√ó</button>
    `,this.addStyles(),i}addStyles(){if(document.getElementById("notification-styles"))return;const e=document.createElement("style");e.id="notification-styles",e.textContent=`
      .notification-container {
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-width: 400px;
      }

      .notification {
        background: rgba(43, 43, 43, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 16px;
        color: #ffffff;
        font-size: 14px;
        line-height: 1.4;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        gap: 12px;
        pointer-events: all;
        transform: translateX(100%);
        opacity: 0;
        transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      }

      .notification-show {
        transform: translateX(0);
        opacity: 1;
      }

      .notification-hide {
        transform: translateX(100%);
        opacity: 0;
      }

      .notification-icon {
        flex-shrink: 0;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 12px;
      }

      .notification-success .notification-icon {
        background: #28a745;
        color: white;
      }

      .notification-error .notification-icon {
        background: #dc3545;
        color: white;
      }

      .notification-warning .notification-icon {
        background: #ffc107;
        color: #212529;
      }

      .notification-info .notification-icon {
        background: #17a2b8;
        color: white;
      }

      .notification-content {
        flex: 1;
        word-wrap: break-word;
      }

      .notification-close {
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.7);
        cursor: pointer;
        font-size: 18px;
        padding: 0;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s;
        flex-shrink: 0;
      }

      .notification-close:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
      }

      /* ÂìçÂ∫îÂºèËÆæËÆ° */
      @media (max-width: 768px) {
        .notification-container {
          right: 10px;
          left: 10px;
          max-width: none;
        }

        .notification {
          font-size: 13px;
          padding: 12px;
        }
      }

      /* Ê∑±Ëâ≤Ê®°ÂºèÈÄÇÈÖç */
      @media (prefers-color-scheme: light) {
        .notification {
          background: rgba(255, 255, 255, 0.95);
          color: #333333;
          border-color: rgba(0, 0, 0, 0.1);
        }

        .notification-close {
          color: rgba(0, 0, 0, 0.6);
        }

        .notification-close:hover {
          background: rgba(0, 0, 0, 0.1);
          color: #333333;
        }
      }
    `,document.head.appendChild(e)}limitNotifications(){if(this.notifications.length>this.maxNotifications){const e=this.notifications.shift();this.hide(e.id)}}clear(){this.notifications.forEach(({id:e})=>{this.hide(e)})}success(e,t){return this.show(e,"success",t)}error(e,t){return this.show(e,"error",t)}warning(e,t){return this.show(e,"warning",t)}info(e,t){return this.show(e,"info",t)}}let silentMode=!0;const notificationInstance=new NotificationManager;window.NotificationUtils=notificationInstance,window.NotificationUtils.showSuccess=(r,e)=>{if(silentMode)return null;try{return notificationInstance.success(r,e)}catch(t){return console.error("NotificationUtils.showSuccess error:",t),null}},window.NotificationUtils.showError=(r,e)=>{if(silentMode)return null;try{return notificationInstance.error(r,e)}catch(t){return console.error("NotificationUtils.showError error:",t),null}},window.NotificationUtils.showWarning=(r,e)=>{if(silentMode)return null;try{return notificationInstance.warning(r,e)}catch(t){return console.error("NotificationUtils.showWarning error:",t),null}},window.NotificationUtils.showInfo=(r,e)=>{if(silentMode)return null;try{return notificationInstance.info(r,e)}catch(t){return console.error("NotificationUtils.showInfo error:",t),null}},window.NotificationUtils.hideStatic=r=>{try{return notificationInstance.hide(r)}catch(e){return console.error("NotificationUtils.hide error:",e),null}},window.NotificationUtils.clearStatic=()=>{try{return notificationInstance.clear()}catch(r){return console.error("NotificationUtils.clear error:",r),null}},window.NotificationUtils.setSilentMode=r=>{silentMode=r},window.NotificationUtils.isSilentMode=()=>silentMode;class ModuleLoader{constructor(){this.modules={helpers:{loaded:!1,file:"js/utils/helpers.js",deps:[]},notification:{loaded:!1,file:"js/utils/notification.js",deps:["helpers"]},"service-worker":{loaded:!1,file:"js/utils/service-worker.js",deps:["helpers"]},"image-optimizer":{loaded:!1,file:"js/utils/image-optimizer.js",deps:["helpers","notification"]},"config-manager":{loaded:!1,file:"js/modules/config-manager.js",deps:["helpers","notification"]},"app-renderer":{loaded:!1,file:"js/modules/app-renderer.js",deps:["helpers","notification","config-manager"]},"ui-controller":{loaded:!1,file:"js/modules/ui-controller.js",deps:["helpers","notification","config-manager","app-renderer"]},"search-engine":{loaded:!1,file:"js/modules/search-engine.js",deps:["helpers","notification","config-manager","image-optimizer"]}},this.globalNames={helpers:"Helpers",notification:"NotificationUtils","service-worker":"ServiceWorkerManager","image-optimizer":"ImageOptimizer","config-manager":"ConfigManager","app-renderer":"AppRenderer","ui-controller":"UIManager","search-engine":"SearchEngine"},this.loadedModules=new Set,this.loadPromises=new Map,this.init()}init(){this.checkLoadedModules()}checkLoadedModules(){Object.keys(this.globalNames).forEach(e=>{const t=this.globalNames[e];typeof window[t]!="undefined"&&(this.modules[e].loaded=!0,this.loadedModules.add(e),console.log(`‚úÖ Ê®°ÂùóÂ∑≤Âä†ËΩΩ: ${e} (${t})`))})}loadModule(e){return d(this,null,function*(){if(this.loadedModules.has(e))return!0;if(this.loadPromises.has(e))return yield this.loadPromises.get(e);if(!this.modules[e])throw new Error(`Êú™Áü•Ê®°Âùó: ${e}`);const n=this._loadModuleDependencies(e);this.loadPromises.set(e,n);try{const i=yield n;return console.log(`üì¶ Ê®°ÂùóÂä†ËΩΩÂÆåÊàê: ${e}`),i}catch(i){throw console.error(`‚ùå Ê®°ÂùóÂä†ËΩΩÂ§±Ë¥•: ${e}`,i),i}finally{this.loadPromises.delete(e)}})}_loadModuleDependencies(e){return d(this,null,function*(){const t=this.modules[e];for(const n of t.deps)yield this.loadModule(n);return this.checkLoadedModules(),this.loadedModules.has(e)?!0:yield this._loadScript(e,t.file)})}_loadScript(e,t){return new Promise((n,i)=>{if(document.querySelector(`script[data-module="${e}"]`)){i(new Error(`Ê®°Âùó ${e} Â∑≤Âú®Âä†ËΩΩ‰∏≠`));return}const o=document.createElement("script");o.src=t,o.async=!0,o.dataset.module=e,o.onload=()=>{setTimeout(()=>{const c=this.globalNames[e];typeof window[c]!="undefined"?(this.modules[e].loaded=!0,this.loadedModules.add(e),console.log(`‚úÖ Ê®°ÂùóÂä†ËΩΩÊàêÂäü: ${e} -> ${c}`),n(!0)):i(new Error(`Ê®°Âùó ${e} Âä†ËΩΩÂêéÊú™ÊâæÂà∞ÂÖ®Â±ÄÂØπË±° ${c}`))},100)},o.onerror=()=>{i(new Error(`Ê®°Âùó ${e} Âä†ËΩΩÂ§±Ë¥•: ${t}`))},document.head.appendChild(o)})}loadAllModules(){return d(this,null,function*(){console.log("üöÄ ÂºÄÂßãÂä†ËΩΩÊâÄÊúâÊ®°Âùó...");try{for(const e of Object.keys(this.modules))yield this.loadModule(e);return console.log("üéâ ÊâÄÊúâÊ®°ÂùóÂä†ËΩΩÂÆåÊàêÔºÅ"),!0}catch(e){throw console.error("‚ùå Ê®°ÂùóÂä†ËΩΩÂ§±Ë¥•:",e),e}})}waitForModules(e,t=1e4){return d(this,null,function*(){const n=Date.now();for(;Date.now()-n<t;){if(this.checkLoadedModules(),e.every(c=>this.loadedModules.has(c)))return!0;yield new Promise(c=>setTimeout(c,100))}const i=e.filter(o=>!this.loadedModules.has(o));throw new Error(`Á≠âÂæÖÊ®°ÂùóË∂ÖÊó∂: ${i.join(", ")}`)})}getLoadedModules(){return this.checkLoadedModules(),Array.from(this.loadedModules)}getMissingModules(){return this.checkLoadedModules(),Object.keys(this.modules).filter(e=>!this.loadedModules.has(e))}getModuleInfo(){this.checkLoadedModules();const e={};return Object.keys(this.modules).forEach(t=>{const n=this.modules[t],i=this.globalNames[t];e[t]={loaded:this.loadedModules.has(t),globalAvailable:typeof window[i]!="undefined",file:n.file,deps:n.deps}}),e}}window.ModuleLoader=new ModuleLoader;class ConfigManager{constructor(){this.CONFIG_KEY="homedock-config",this.API_ENDPOINT=this.resolveApiEndpoint(),this.cachedConfig=null}resolveApiEndpoint(){try{const{origin:e,hostname:t}=window.location||{};return t&&t.endsWith(".pages.dev")?"https://homedock.piaozhitian.workers.dev/api/config":e&&e.startsWith("http")?e.replace(/\/+$/,"")+"/api/config":"/api/config"}catch(e){return console.warn("API Á´ØÁÇπËß£ÊûêÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞ÈªòËÆ§ /api/config",e),"/api/config"}}loadConfigWithRetry(e=3){return d(this,null,function*(){for(let t=0;t<e;t++)try{const n=yield this.loadConfigFromServer();if(n&&this.validateConfig(n))return this.cachedConfig=n,localStorage.setItem(this.CONFIG_KEY,JSON.stringify(n)),n}catch(n){console.warn(`ÈÖçÁΩÆÂä†ËΩΩÂ∞ùËØï ${t+1} Â§±Ë¥•:`,n),t===e-1&&NotificationUtils.showWarning("ÈÖçÁΩÆÂä†ËΩΩÂ§±Ë¥•Ôºå‰ΩøÁî®Êú¨Âú∞ÁºìÂ≠ò"),yield new Promise(i=>setTimeout(i,1e3*(t+1)))}return this.loadLocalConfig()})}loadConfigFromServer(){return d(this,null,function*(){try{const e=yield fetch(this.API_ENDPOINT,{method:"GET",headers:{Accept:"application/json","Cache-Control":"no-cache"}});if(!e.ok)throw new Error(`HTTP ${e.status}: ${e.statusText}`);const t=yield e.json();if(t===null)return console.info("ÊúçÂä°Âô®ËøîÂõû nullÔºåÂõûÈÄÄÂà∞Êú¨Âú∞ÈÖçÁΩÆ"),null;if(!this.validateConfig(t))throw new Error("ÊúçÂä°Âô®ËøîÂõûÁöÑÈÖçÁΩÆÊ†ºÂºèÊó†Êïà");return this.normalizeConfig(t)}catch(e){return console.error("‰ªéÊúçÂä°Âô®Âä†ËΩΩÈÖçÁΩÆÂ§±Ë¥•:",e),null}})}loadLocalConfig(){try{const e=JSON.parse(localStorage.getItem(this.CONFIG_KEY));return e&&this.validateConfig(e)?(this.cachedConfig=e,e):this.loadDefaultConfig()}catch(e){return console.error("Âä†ËΩΩÊú¨Âú∞ÈÖçÁΩÆÂ§±Ë¥•:",e),this.loadDefaultConfig()}}loadDefaultConfig(){return d(this,null,function*(){try{const t=yield(yield fetch("apps-config.json")).json(),n=this.normalizeConfig(t);return this.cachedConfig=n,localStorage.setItem(this.CONFIG_KEY,JSON.stringify(n)),n}catch(e){return console.error("Âä†ËΩΩÈªòËÆ§ÈÖçÁΩÆÂ§±Ë¥•:",e),NotificationUtils.showError("ÈÖçÁΩÆÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï"),null}})}saveConfig(e){return d(this,null,function*(){if(!this.validateConfig(e))throw new Error("ÈÖçÁΩÆÊ†ºÂºèÊó†Êïà");localStorage.setItem(this.CONFIG_KEY,JSON.stringify(e)),this.cachedConfig=e;try{yield this.saveConfigToServer(e),NotificationUtils.showSuccess("ÈÖçÁΩÆÂ∑≤‰øùÂ≠ò")}catch(t){console.warn("‰øùÂ≠òÂà∞ÊúçÂä°Âô®Â§±Ë¥•Ôºå‰ªÖ‰øùÂ≠òÂà∞Êú¨Âú∞:",t),NotificationUtils.showWarning("ÈÖçÁΩÆÂ∑≤‰øùÂ≠òÂà∞Êú¨Âú∞")}})}saveConfigToServer(e){return d(this,null,function*(){const t=yield fetch(this.API_ENDPOINT,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw new Error(`‰øùÂ≠òÂ§±Ë¥•: ${t.status}`)})}validateConfig(e){return e&&typeof e=="object"&&Array.isArray(e.applications)&&e.applications.every(t=>typeof t.name=="string"&&t.name.trim().length>0)}normalizeConfig(e){return e.background||(e.background={mode:"wallpaper",solidColor:"#202124",gradientFrom:"#141e30",gradientTo:"#243b55"}),e.applications=e.applications.map(t=>h({name:t.name||"Êú™ÂëΩÂêçÂ∫îÁî®",external_url:t.external_url||"",internal_url:t.internal_url||"",icon:t.icon||"img/png/favicon.svg"},t)),e}getCurrentConfig(){return this.cachedConfig||this.loadLocalConfig()}addApplication(e){const t=this.getCurrentConfig();return t.applications.push(e),this.saveConfig(t)}updateApplication(e,t){const n=this.getCurrentConfig();if(n.applications[e])return n.applications[e]=h(h({},n.applications[e]),t),this.saveConfig(n);throw new Error("Â∫îÁî®‰∏çÂ≠òÂú®")}deleteApplication(e){const t=this.getCurrentConfig();if(t.applications[e])return t.applications.splice(e,1),this.saveConfig(t);throw new Error("Â∫îÁî®‰∏çÂ≠òÂú®")}reorderApplications(e,t){const n=this.getCurrentConfig(),[i]=n.applications.splice(e,1);return n.applications.splice(t,0,i),this.saveConfig(n)}updateBackground(e){const t=this.getCurrentConfig();return t.background=h(h({},t.background),e),this.saveConfig(t)}}window.ConfigManager=new ConfigManager;class AppRenderer{constructor(){this.APPS_PER_PAGE=15,this.externalPageIndex=0,this.internalPageIndex=0,this.editMode=!1,this.configManager=window.ConfigManager,this.init()}init(){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>this.setupEventListeners()):this.setupEventListeners()}setupEventListeners(){const e=DOM.find("#edit-toggle-btn");e&&DOM.on(e,"click",t=>{t.stopPropagation(),this.toggleEditMode()}),this.setupPagingControls(),DOM.on(document,"click",t=>{this.editMode&&!t.target.closest(".app-item")&&!t.target.closest(".edit-modal")&&!t.target.closest("#edit-toggle-btn")&&this.exitEditMode()}),DOM.on(document,"keydown",t=>{t.ctrlKey&&t.key==="e"&&(t.preventDefault(),this.toggleEditMode())})}renderExternalApps(){const e=DOM.find("#external-apps"),t=DOM.find("#external-next-btn");if(!e){console.warn("‚ö†Ô∏è #external-apps container not found");return}e.innerHTML="";let n=this.configManager.getCurrentConfig();if(!n||typeof n.then=="function"||!Array.isArray(n.applications)){console.warn("‚ö†Ô∏è No valid config found, reloading config..."),this.configManager.loadConfigWithRetry().then(()=>{this.renderExternalApps(),this.renderInternalApps()}).catch(o=>{console.error("‚ùå Failed to reload config:",o)});return}const i=n.applications.map((o,c)=>({app:o,index:c})).filter(o=>o.app.external_url&&o.app.external_url.trim()&&o.app.external_url!=="#");if(this.renderApps(e,i,"external",this.externalPageIndex),t){const o=i.length;t.classList.toggle("page-arrow-hidden",o<=this.APPS_PER_PAGE)}}renderInternalApps(){const e=DOM.find("#internal-apps"),t=DOM.find("#internal-next-btn");if(!e){console.warn("‚ö†Ô∏è #internal-apps container not found");return}e.innerHTML="";let n=this.configManager.getCurrentConfig();if(!n||typeof n.then=="function"||!Array.isArray(n.applications)){console.warn("‚ö†Ô∏è No valid config found for internal apps, reloading config..."),this.configManager.loadConfigWithRetry().then(()=>{this.renderInternalApps()}).catch(o=>{console.error("‚ùå Failed to reload config for internal apps:",o)});return}const i=n.applications.map((o,c)=>({app:o,index:c})).filter(o=>o.app.internal_url&&o.app.internal_url.trim()&&o.app.internal_url!=="#");if(this.renderApps(e,i,"internal",this.internalPageIndex),t){const o=i.length;t.classList.toggle("page-arrow-hidden",o<=this.APPS_PER_PAGE)}}renderApps(e,t,n,i){const o=t.length,c=Math.max(0,Math.ceil(o/this.APPS_PER_PAGE)-1);i>c&&(i=0,n==="external"?this.externalPageIndex=0:this.internalPageIndex=0);const a=i*this.APPS_PER_PAGE;t.slice(a,a+this.APPS_PER_PAGE).forEach(({app:p,index:g})=>{const u=this.createAppItem(p,g,n);e.appendChild(u)});const l=this.createAddAppItem(n);e.appendChild(l),this.enableDragAndDrop(e,n)}createAppItem(e,t,n){const i=DOM.create("li",{className:"app-page-item",draggable:!0,"data-app-index":t,"data-app-type":n}),o=n==="external"?e.external_url:e.internal_url,c=e.icon&&e.icon.trim()?e.icon:"img/png/favicon.svg",a=o&&o.startsWith("#")?"_self":"_blank",s=DOM.create("div",{className:"app-item","data-app-index":t},[DOM.create("a",{"data-url":Helpers.escapeUrl(o),"data-target":a,role:"button",tabindex:"0"},[DOM.create("img",{className:"shake",src:c,alt:Helpers.escapeHtml(e.name),onerror:"this.onerror=null;this.src='img/png/favicon.svg'"}),DOM.create("strong",{},[Helpers.escapeHtml(e.name)])]),this.createEditButtons(t)]),l=s.querySelector("a");return l&&DOM.on(l,"click",p=>{p.preventDefault();const g=l.getAttribute("data-url"),u=l.getAttribute("data-target")||"_blank";g&&g!=="#"&&g.trim()!==""&&(u==="_blank"?window.open(g,"_blank","noopener,noreferrer"):window.location.href=g)}),DOM.on(s,"contextmenu",p=>{p.preventDefault(),this.enterEditMode()}),i.appendChild(s),i}createEditButtons(e){const t=document.createElementNS("http://www.w3.org/2000/svg","svg");t.setAttribute("class","edit-icon-svg"),t.setAttribute("xmlns","http://www.w3.org/2000/svg"),t.setAttribute("width","16"),t.setAttribute("height","16"),t.setAttribute("viewBox","0 0 24 24"),t.setAttribute("fill","none"),t.setAttribute("stroke","currentColor"),t.setAttribute("stroke-width","2"),t.setAttribute("stroke-linecap","round"),t.setAttribute("stroke-linejoin","round"),t.innerHTML='<path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>';const n=DOM.create("button",{className:"edit-btn icon-btn",style:"display: none;"},[]);n.appendChild(t);const i=DOM.create("button",{className:"icon-btn delete-btn",style:"display: none;"});return DOM.on(n,"click",o=>{o.stopPropagation(),window.UIManager.editApp(e)}),DOM.on(i,"click",o=>{o.stopPropagation(),window.UIManager.deleteApp(e)}),[n,i]}createAddAppItem(e){const t=DOM.create("li",{className:"app-page-item add-app-item"}),n=DOM.create("div",{className:"app-item add-app-item-inner"},[DOM.create("strong",{},["+ Ê∑ªÂä†Â∫îÁî®"])]);return DOM.on(n,"click",i=>{i.preventDefault(),i.stopPropagation(),window.UIManager&&typeof window.UIManager.openAddApp=="function"&&window.UIManager.openAddApp(e)}),t.appendChild(n),t}enableDragAndDrop(e,t){let n=null,i=null,o=null;const c=()=>{n&&n.classList.remove("dragging"),o&&o.classList.remove("drag-over"),n=null,i=null,o=null};DOM.on(e,"dragstart",a=>{const s=a.target.closest(".app-page-item");!s||s.classList.contains("add-app-item")||(n=s,i=parseInt(n.dataset.appIndex),n.classList.add("dragging"),a.dataTransfer&&(a.dataTransfer.effectAllowed="move",a.dataTransfer.setData("text/plain","")))}),DOM.on(e,"dragover",a=>{if(a.preventDefault(),!n)return;a.dataTransfer&&(a.dataTransfer.dropEffect="move");const s=a.target.closest(".app-page-item");if(!s||s===n||s.classList.contains("add-app-item"))return;o&&o!==s&&o.classList.remove("drag-over"),s.classList.add("drag-over"),o=s;const l=s.getBoundingClientRect();a.clientY-l.top<l.height/2?e.insertBefore(n,s):e.insertBefore(n,s.nextSibling)}),DOM.on(e,"drop",a=>d(this,null,function*(){if(a.preventDefault(),n){n.classList.remove("dragging"),o&&o.classList.remove("drag-over");const l=Array.from(e.querySelectorAll(".app-page-item:not(.add-app-item)")).indexOf(n);if(l!==i)try{yield this.configManager.reorderApplications(i,l),NotificationUtils.showSuccess("Â∫îÁî®È°∫Â∫èÂ∑≤Êõ¥Êñ∞"),t==="external"?this.renderExternalApps():this.renderInternalApps()}catch(p){NotificationUtils.showError("Êõ¥Êñ∞È°∫Â∫èÂ§±Ë¥•: "+p.message)}}})),DOM.on(e,"dragend",()=>{c()}),DOM.on(e,"dragleave",a=>{const s=a.target.closest(".app-page-item");s&&s.classList.remove("drag-over")}),DOM.on(window,"mouseup",()=>{n&&c()})}getDragAfterElement(e,t){return[...e.querySelectorAll(".app-page-item:not(.dragging):not(.add-app-item)")].reduce((i,o)=>{const c=o.getBoundingClientRect(),a=t-c.top-c.height/2;return a<0&&a>i.offset?{offset:a,element:o}:i},{offset:Number.NEGATIVE_INFINITY}).element}setupPagingControls(){const e=DOM.find("#external-next-btn"),t=DOM.find("#internal-next-btn");e&&DOM.on(e,"click",()=>{this.nextPage("external")}),t&&DOM.on(t,"click",()=>{this.nextPage("internal")})}nextPage(e){const t=this.configManager.getCurrentConfig();if(!t||!Array.isArray(t.applications))return;const n=t.applications.filter(o=>e==="external"?o.external_url:o.internal_url),i=Math.max(0,Math.ceil(n.length/this.APPS_PER_PAGE)-1);e==="external"?(this.externalPageIndex=this.externalPageIndex>=i?0:this.externalPageIndex+1,this.renderExternalApps()):(this.internalPageIndex=this.internalPageIndex>=i?0:this.internalPageIndex+1,this.renderInternalApps()),this.editMode&&this.addRightClickEdit()}toggleEditMode(){this.editMode?this.exitEditMode():this.enterEditMode()}enterEditMode(){this.editMode=!0,document.body.classList.add("edit-mode"),DOM.findAll(".delete-btn").forEach(n=>{n.style.display="flex"}),DOM.findAll(".shake, .edit-shake").forEach(n=>{n.classList.remove("shake","edit-shake")}),DOM.findAll(".app-item img").forEach(n=>{n.classList.add("edit-shake")}),DOM.findAll(".edit-btn").forEach(n=>{n.classList.add("edit-shake")});const e=DOM.find("#edit-toggle-btn"),t=DOM.find(".edit-text");e&&t&&(e.classList.add("editing"),e.setAttribute("aria-pressed","true"),t.textContent="ÂÆåÊàê"),this.addRightClickEdit()}exitEditMode(){this.editMode=!1,document.body.classList.remove("edit-mode"),DOM.findAll(".icon-btn").forEach(n=>{n.style.display="none"}),DOM.findAll(".edit-shake").forEach(n=>{n.classList.remove("edit-shake")}),DOM.findAll(".app-item img").forEach(n=>{n.classList.add("shake")});const e=DOM.find("#edit-toggle-btn"),t=DOM.find(".edit-text");e&&t&&(e.classList.remove("editing"),e.setAttribute("aria-pressed","false"),t.textContent="ÁºñËæë")}addRightClickEdit(){DOM.findAll(".app-item a").forEach(e=>{DOM.on(e,"contextmenu",t=>{t.preventDefault(),this.editMode||this.enterEditMode()})})}refresh(){this.externalPageIndex=0,this.internalPageIndex=0,this.renderExternalApps(),this.renderInternalApps(),this.editMode&&this.addRightClickEdit()}}window.AppRenderer=new AppRenderer;class UIController{constructor(){this.configManager=window.ConfigManager,this.appRenderer=window.AppRenderer,this.init()}init(){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>this.setupAll()):this.setupAll()}setupAll(){try{this.setupModalEvents(),this.setupAppToggle(),this.setupEngineDisplay(),this.setupSearchFunction();const e=DOM.find("#iconPickerToggle");e&&DOM.on(e,"click",t=>{t.preventDefault(),t.stopPropagation(),this.showIconSelector()}),console.log("‚úÖ UI Controller ÂàùÂßãÂåñÂÆåÊàê")}catch(e){console.error("‚ùå UI Controller ÂàùÂßãÂåñÂ§±Ë¥•:",e)}}setupModalEvents(){const e=DOM.find("#editModal");if(!e)return;const t=DOM.find(".edit-modal-close");t&&DOM.on(t,"click",()=>this.hideEditModal());const n=DOM.find(".btn-cancel");n&&DOM.on(n,"click",()=>this.hideEditModal());const i=DOM.find("#editForm");i&&DOM.on(i,"submit",o=>{o.preventDefault(),this.saveEditedApp()}),DOM.on(e,"click",o=>{o.target===e&&this.hideEditModal()}),DOM.on(document,"keydown",o=>{o.key==="Escape"&&e.style.display==="flex"&&this.hideEditModal()})}setupAppToggle(){const e=DOM.find(".switch-btn-left"),t=DOM.find(".switch-btn-right"),n=DOM.find("#app"),i=DOM.find("#app1");if(!e||!t||!n||!i)return;const o=Helpers.Storage.get("homedock-app-view","external");o==="internal"?(e.classList.remove("active"),t.classList.add("active"),e.setAttribute("aria-pressed","false"),t.setAttribute("aria-pressed","true")):(e.classList.add("active"),t.classList.remove("active"),e.setAttribute("aria-pressed","true"),t.setAttribute("aria-pressed","false")),this.updateAppView(o==="internal",n,i),DOM.on(e,"click",()=>{e.classList.add("active"),t.classList.remove("active"),e.setAttribute("aria-pressed","true"),t.setAttribute("aria-pressed","false"),Helpers.Storage.set("homedock-app-view","external"),this.updateAppView(!1,n,i)}),DOM.on(t,"click",()=>{t.classList.add("active"),e.classList.remove("active"),t.setAttribute("aria-pressed","true"),e.setAttribute("aria-pressed","false"),Helpers.Storage.set("homedock-app-view","internal"),this.updateAppView(!0,n,i)})}updateAppView(e,t,n){e?(DOM.hide(t),DOM.show(n)):(DOM.show(t),DOM.hide(n))}setupEngineDisplay(){const e=DOM.find("#search-engine"),t=DOM.find("#current-engine-label"),n=DOM.find("#search-box"),i=DOM.find("#search-engine-selector"),o=DOM.find("#search-engine-dropdown"),c=DOM.findAll(".dropdown-item");if(!e||!t||!n||!i||!o)return;const a=Helpers.Storage.get("homedock-search-engine","baidu");e.value=a,this.updateEngineDisplay(a),DOM.on(i,"click",s=>{s.stopPropagation(),this.toggleEngineDropdown()}),c.forEach(s=>{DOM.on(s,"click",l=>{l.stopPropagation();const p=s.dataset.engine;e.value!==p&&(e.value=p,Helpers.Storage.set("homedock-search-engine",p),this.updateEngineDisplay(p)),this.hideEngineDropdown()})}),DOM.on(document,"click",s=>{!s.target.closest("#search-engine-selector")&&!s.target.closest(".search-engine-dropdown")&&this.hideEngineDropdown()})}toggleEngineDropdown(){const e=DOM.find("#search-engine-selector");DOM.find("#search-engine-dropdown").classList.contains("show")?this.hideEngineDropdown():this.showEngineDropdown()}showEngineDropdown(){const e=DOM.find("#search-engine-selector"),t=DOM.find("#search-engine-dropdown");e.classList.add("open"),t.classList.add("show")}hideEngineDropdown(){const e=DOM.find("#search-engine-selector"),t=DOM.find("#search-engine-dropdown");e.classList.remove("open"),t.classList.remove("show")}updateEngineDisplay(e){const t=DOM.find("#current-engine-label"),n=DOM.find("#search-engine-logo"),i=DOM.find("#search-box");let o="",c="",a="";switch(e){case"google":o="img/google-official.svg",c="Google",a="Google";break;case"bing":o="img/Bing.svg",c="Bing",a="Bing";break;case"baidu":o="img/baidu.svg",c="Baidu",a="ÁôæÂ∫¶";break}n&&(n.src=o,n.alt=c),t&&(t.textContent=a),i.classList.remove("engine-google","engine-bing","engine-baidu"),i.classList.add(`engine-${e}`)}openAddApp(e){const t=DOM.find("#editModal");t&&(DOM.find("#appName").value="",DOM.find("#externalUrl").value="",DOM.find("#internalUrl").value="",DOM.find("#iconPath").value="",t.dataset.appIndex=e==="external"?"new-external":"new-internal",DOM.show(t),t.style.display="flex",setTimeout(()=>{DOM.find("#appName").focus()},100))}editApp(e){return d(this,null,function*(){const n=this.configManager.getCurrentConfig().applications[e];if(!n){NotificationUtils.showError("Â∫îÁî®‰∏çÂ≠òÂú®");return}DOM.find("#appName").value=n.name||"",DOM.find("#externalUrl").value=n.external_url||"",DOM.find("#internalUrl").value=n.internal_url||"",DOM.find("#iconPath").value=n.icon||"";const i=DOM.find("#editModal");i.dataset.appIndex=e,DOM.show(i),i.style.display="flex",setTimeout(()=>{DOM.find("#appName").focus()},100)})}saveEditedApp(){return d(this,null,function*(){var o,c,a,s;const t=DOM.find("#editModal").dataset.appIndex,n=new FormData(DOM.find("#editForm")),i={name:(o=n.get("appName"))==null?void 0:o.trim(),external_url:(c=n.get("externalUrl"))==null?void 0:c.trim(),internal_url:(a=n.get("internalUrl"))==null?void 0:a.trim(),icon:(s=n.get("iconPath"))==null?void 0:s.trim()};if(!i.name){NotificationUtils.showError("ËØ∑ËæìÂÖ•Â∫îÁî®ÂêçÁß∞");return}if(!i.external_url&&!i.internal_url){NotificationUtils.showError("ËØ∑Ëá≥Â∞ëËæìÂÖ•‰∏Ä‰∏™URLÂú∞ÂùÄ");return}if(i.external_url&&!this.validateUrl(i.external_url)){NotificationUtils.showError("Â§ñÈÉ®URLÊ†ºÂºè‰∏çÊ≠£Á°Æ");return}if(i.internal_url&&!this.validateUrl(i.internal_url)){NotificationUtils.showError("ÂÜÖÈÉ®URLÊ†ºÂºè‰∏çÊ≠£Á°Æ");return}try{if(t==="new-external"||t==="new-internal")yield this.configManager.addApplication(i),NotificationUtils.showSuccess("Â∫îÁî®Ê∑ªÂä†ÊàêÂäü");else{const l=parseInt(t,10);yield this.configManager.updateApplication(l,i),NotificationUtils.showSuccess("Â∫îÁî®Êõ¥Êñ∞ÊàêÂäü")}this.hideEditModal(),this.appRenderer.refresh()}catch(l){console.error("‰øùÂ≠òÂ∫îÁî®Â§±Ë¥•:",l),NotificationUtils.showError("‰øùÂ≠òÂ§±Ë¥•: "+l.message)}})}deleteApp(e){return d(this,null,function*(){if(confirm("Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Â∫îÁî®ÂêóÔºü"))try{yield this.configManager.deleteApplication(e),NotificationUtils.showSuccess("Â∫îÁî®Â∑≤Âà†Èô§"),this.appRenderer.refresh()}catch(t){console.error("Âà†Èô§Â∫îÁî®Â§±Ë¥•:",t),NotificationUtils.showError("Âà†Èô§Â§±Ë¥•: "+t.message)}})}validateUrl(e){if(!e||e==="#")return!0;try{return new URL(e),!0}catch(t){try{return new URL("http://"+e),!0}catch(n){return!1}}}hideEditModal(){const e=DOM.find("#editModal");e&&(e.style.display="none")}showIconSelector(){const e=DOM.find("#iconPicker"),t=DOM.find("#iconPickerGrid"),n=DOM.find("#iconPath");if(!(!e||!t||!n)){if(e.dataset.initialized!=="true"){const i=window.PRESET_ICONS||[];t.innerHTML="",i.forEach(o=>{const c=DOM.create("div",{className:"icon-picker-item"},[DOM.create("img",{src:o.path,alt:o.name}),DOM.create("span",{},[o.name])]);DOM.on(c,"click",()=>{n.value=o.path,n.focus(),e.style.display="none"}),t.appendChild(c)}),e.dataset.initialized="true"}e.style.display==="block"?e.style.display="none":e.style.display="block"}}setupSearchFunction(){const e=DOM.find("#search-input");e&&(DOM.on(e,"keypress",t=>{t.key==="Enter"&&this.performSearch()}),this.setupSearchAutocomplete(e))}setupSearchAutocomplete(e){const t="homedock-search-history";let n;DOM.on(e,"input",i=>{clearTimeout(n);const o=i.target.value.trim();if(o.length<2){this.hideAutocomplete();return}n=setTimeout(()=>{this.showAutocomplete(o,t)},200)}),DOM.on(document,"click",i=>{!i.target.closest(".search-autocomplete")&&i.target!==e&&this.hideAutocomplete()})}showAutocomplete(e,t){const i=Helpers.Storage.get(t,[]).filter(l=>l.toLowerCase().includes(e.toLowerCase())).slice(0,5);if(i.length===0){this.hideAutocomplete();return}const o=DOM.find("#search-input"),c=DOM.create("div",{className:"search-autocomplete"});i.forEach(l=>{const p=DOM.create("div",{className:"search-suggestion",onclick:()=>{o.value=l,this.performSearch(),this.hideAutocomplete()}},[Helpers.escapeHtml(l)]);c.appendChild(p)});const a=DOM.find("#search-box"),s=DOM.find(".search-autocomplete");s&&a.removeChild(s),a.appendChild(c)}hideAutocomplete(){const e=DOM.find(".search-autocomplete");e&&e.parentNode.removeChild(e)}performSearch(){const e=DOM.find("#search-input"),t=DOM.find("#search-engine"),n=e.value.trim();if(!n){NotificationUtils.showError("ËØ∑ËæìÂÖ•ÊêúÁ¥¢ÂÜÖÂÆπ");return}const i="homedock-search-history";let o=Helpers.Storage.get(i,[]);o=o.filter(s=>s!==n),o.unshift(n),o=o.slice(0,10),Helpers.Storage.set(i,o);const c=t.value;let a;switch(c){case"google":a=`https://www.google.com/search?q=${encodeURIComponent(n)}`;break;case"bing":a=`https://cn.bing.com/search?q=${encodeURIComponent(n)}`;break;case"baidu":a=`https://www.baidu.com/s?wd=${encodeURIComponent(n)}`;break;default:a=`https://www.google.com/search?q=${encodeURIComponent(n)}`}window.open(a,"_blank")}}window.UIManager=new UIController;class SearchEngine{constructor(){this.configManager=window.ConfigManager,this.init()}init(){this.setupBackgroundManager(),this.setupSearchShortcuts()}setupBackgroundManager(){const e=DOM.find("#change-wallpaper-btn");e&&DOM.on(e,"click",()=>{this.changeWallpaper()})}applyBackgroundFromConfig(e=!1){const t=this.configManager.getCurrentConfig();if(!t){this.setupBingBackground(),this.applyBackgroundBlur("light");return}const n=DOM.find("#change-wallpaper-btn"),i=t.background;if(!i||!i.mode){n&&DOM.show(n),this.setupBingBackground(),this.applyBackgroundBlur("light");return}switch(this.applyBackgroundBlur(i.blur||"light"),i.mode){case"wallpaper":n&&DOM.show(n),this.setupBingBackground(e);break;case"solid":n&&DOM.hide(n),this.applySolidBackground(i.solidColor||"#202124");break;case"gradient":n&&DOM.hide(n),this.applyGradientBackground(i.gradientFrom||"#141e30",i.gradientTo||"#243b55");break;default:n&&DOM.show(n),this.setupBingBackground()}}setupBingBackground(e=!1){const t=e?Date.now():"",n=this.resolveWallpaperUrl(`ts=${t}`);console.log("üñºÔ∏è Setting up Bing wallpaper:",n),document.body.style.backgroundColor="#000000",document.body.style.backgroundRepeat="no-repeat",document.body.style.backgroundPosition="center center",document.body.style.backgroundAttachment="fixed",document.body.style.backgroundSize="100% 100%";const i=new Image;i.onload=()=>{console.log("‚úÖ Bing wallpaper loaded successfully"),document.body.style.backgroundImage=`linear-gradient(rgba(0, 0, 0, 0.35), rgba(0, 0, 0, 0.35)), url('${n}')`,document.body.style.backgroundRepeat="no-repeat",document.body.style.backgroundSize="100% 100%",document.body.style.backgroundPosition="center center",document.body.style.backgroundAttachment="fixed"},i.onerror=o=>{console.warn("‚ùå Failed to load Bing wallpaper, using fallback:",o),this.applyGradientBackground("#141e30","#243b55")},i.addEventListener("error",()=>{console.warn("‚è∞ Bing wallpaper load timeout"),this.applyGradientBackground("#141e30","#243b55")},{once:!0}),setTimeout(()=>{i.complete||(i.src="",i.onerror(new Error("Timeout")))},1e4),i.src=n}applySolidBackground(e){document.body.style.backgroundImage="none",document.body.style.backgroundColor=e,document.body.style.backgroundRepeat="repeat",document.body.style.backgroundSize="auto",document.body.style.backgroundPosition="top left",document.body.style.backgroundAttachment="scroll"}applyGradientBackground(e,t){document.body.style.backgroundImage=`linear-gradient(135deg, ${e}, ${t})`,document.body.style.backgroundColor="#000000",document.body.style.backgroundRepeat="no-repeat",document.body.style.backgroundSize="cover",document.body.style.backgroundPosition="center center",document.body.style.backgroundAttachment="fixed"}changeWallpaper(){return d(this,null,function*(){try{this.applyBackgroundFromConfig(!0)}catch(e){console.error("Failed to change wallpaper:",e)}})}setupSearchShortcuts(){DOM.on(document,"keydown",t=>{if((t.ctrlKey||t.metaKey)&&t.key==="k"){t.preventDefault();const n=DOM.find("#search-input");n&&(n.focus(),n.select())}if(t.key==="Escape"){const n=DOM.find("#search-input");n===document.activeElement&&(n.value="",n.blur(),this.hideAutocomplete())}});const e=DOM.find("#search-input");e&&(DOM.on(e,"focus",()=>{e.parentElement.classList.add("search-focused")}),DOM.on(e,"blur",()=>{e.parentElement.classList.remove("search-focused")}))}getSearchSuggestions(e){return d(this,null,function*(){if(e.length<2)return[];try{return yield this.fetchGoogleSuggestions(e)}catch(t){return console.warn("Failed to fetch search suggestions:",t),[]}})}fetchGoogleSuggestions(e){return d(this,null,function*(){try{const t=yield fetch(`https://suggestqueries.google.com/complete/search?client=firefox&q=${encodeURIComponent(e)}`,{mode:"cors"});return[]}catch(t){return[]}})}hideAutocomplete(){const e=DOM.find(".search-autocomplete");e&&e.parentNode.removeChild(e)}preloadNextWallpaper(){try{const e=new Image;e.onload=()=>{console.log("‚úÖ Â£ÅÁ∫∏È¢ÑÂä†ËΩΩÊàêÂäü")},e.onerror=()=>{console.warn("‚ö†Ô∏è Â£ÅÁ∫∏È¢ÑÂä†ËΩΩÂ§±Ë¥•")},e.src=this.resolveWallpaperUrl("preload=true&ts="+Date.now())}catch(e){console.warn("‚ö†Ô∏è Â£ÅÁ∫∏È¢ÑÂä†ËΩΩÂá∫Èîô:",e)}}resolveWallpaperUrl(e){try{const{origin:t,hostname:n}=window.location||{};return n&&n.endsWith(".pages.dev")?`https://homedock.piaozhitian.workers.dev/bing-wallpaper?${e}`:t&&t.startsWith("http")?t.replace(/\/+$/,"")+`/bing-wallpaper?${e}`:`/bing-wallpaper?${e}`}catch(t){return console.warn("Â£ÅÁ∫∏Âú∞ÂùÄËß£ÊûêÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞Áõ∏ÂØπË∑ØÂæÑ",t),`/bing-wallpaper?${e}`}}setupWallpaperAutoChange(e=36e5){Helpers.Storage.get("homedock-auto-change-wallpaper",!1)&&setInterval(()=>{this.changeWallpaper()},e)}optimizeBackgroundPerformance(){if(document.body.style.willChange="background-image",this.detectLowPerformanceDevice()){const t=this.configManager.getCurrentConfig();t&&t.background&&t.background.mode==="wallpaper"&&this.applySolidBackground("#202124")}}detectLowPerformanceDevice(){const e=navigator.deviceMemory||4,t=navigator.connection||navigator.mozConnection||navigator.webkitConnection;return e<2||t&&t.effectiveType&&["slow-2g","2g","3g"].includes(t.effectiveType)}setupBackgroundCaching(){"serviceWorker"in navigator&&navigator.serviceWorker.ready.then(e=>{e.addEventListener("message",t=>{t.data.type==="CACHE_UPDATED"&&console.log("Background cache updated")})})}applyBackgroundBlur(e){const t=document.body;switch(t.classList.remove("bg-blur-none","bg-blur-light","bg-blur-medium","bg-blur-heavy"),e){case"none":t.classList.add("bg-blur-none");break;case"light":t.classList.add("bg-blur-light");break;case"medium":t.classList.add("bg-blur-medium");break;case"heavy":t.classList.add("bg-blur-heavy");break;default:t.classList.add("bg-blur-light");break}console.log("üé® Applied background blur level:",e)}}window.SearchEngine=new SearchEngine,window.PRESET_ICONS||(window.PRESET_ICONS=[{path:"img/png/Edge.svg",name:"Edge"},{path:"img/png/Firefox.svg",name:"Firefox"},{path:"img/png/Adminer.svg",name:"Adminer"},{path:"img/png/Ai.svg",name:"Ai"},{path:"img/png/Alist.svg",name:"Alist"},{path:"img/png/Aria2.svg",name:"Aria2"},{path:"img/png/Book.svg",name:"Book"},{path:"img/png/Calibre.png",name:"Calibre"},{path:"img/png/Chatgpt.png",name:"ChatGPT"},{path:"img/png/Cloud.svg",name:"Cloud"},{path:"img/png/Downloads.png",name:"Downloads"},{path:"img/png/Emby.svg",name:"Emby"},{path:"img/png/FaceTime.png",name:"FaceTime"},{path:"img/png/File.svg",name:"File"},{path:"img/png/FileBrowser.svg",name:"FileBrowser"},{path:"img/png/FileSync.svg",name:"FileSync"},{path:"img/png/HPE.svg",name:"HPE"},{path:"img/png/Homarr.png",name:"Homarr"},{path:"img/png/Jellyfin.svg",name:"Jellyfin"},{path:"img/png/KMS.svg",name:"KMS"},{path:"img/png/Lucky.svg",name:"Lucky"},{path:"img/png/MariaDB.svg",name:"MariaDB"},{path:"img/png/MovieTool.svg",name:"MovieTool"},{path:"img/png/Music.svg",name:"Music"},{path:"img/png/MyAdmin.svg",name:"MyAdmin"},{path:"img/png/NasTool.svg",name:"NasTool"},{path:"img/png/Openwrt.svg",name:"OpenWrt"},{path:"img/png/PVE.svg",name:"PVE"},{path:"img/png/Photos.svg",name:"Photos"},{path:"img/png/Podcats.png",name:"Podcasts"},{path:"img/png/Portainer.svg",name:"Portainer"},{path:"img/png/Print.svg",name:"Print"},{path:"img/png/Qb.svg",name:"Qbittorrent"},{path:"img/png/QingLong.svg",name:"QingLong"},{path:"img/png/S-PDF.svg",name:"S-PDF"},{path:"img/png/Sam.svg",name:"Sam"},{path:"img/png/Server.svg",name:"Server"},{path:"img/png/Settings.png",name:"Settings"},{path:"img/png/Thunder.png",name:"Thunder"},{path:"img/png/Transmission.png",name:"Transmission"},{path:"img/png/Unraid.svg",name:"Unraid"},{path:"img/png/VM.svg",name:"VM"},{path:"img/png/Videos.svg",name:"Videos"},{path:"img/png/XunLei.svg",name:"XunLei"},{path:"img/png/iCloud-Drive.png",name:"iCloud Drive"},{path:"img/png/nginxWebUI.png",name:"nginxWebUI"},{path:"img/png/favicon.svg",name:"Favicon"},{path:"img/png/favicon2.svg",name:"Favicon2"},{path:"img/png/logo.svg",name:"Logo"},{path:"img/png/Áå´logo2.svg",name:"Áå´Logo"},{path:"img/png/DPanel.svg",name:"DPanel"},{path:"img/png/AdGuard.svg",name:"AdGuard"},{path:"img/png/Esxi.svg",name:"Esxi"}]);class ServiceWorkerManager{constructor(){this.swUrl="/sw.js",this.isSupported="serviceWorker"in navigator,this.controller=null,this.updateAvailable=!1,this.init()}init(){if(!this.isSupported){console.warn("Service Worker not supported");return}this.registerServiceWorker(),this.setupMessageListener(),this.checkForUpdates()}registerServiceWorker(){return d(this,null,function*(){try{const e=yield navigator.serviceWorker.register(this.swUrl,{scope:"/"});console.log("Service Worker registered successfully:",e),e.addEventListener("updatefound",()=>{const t=e.installing;t.addEventListener("statechange",()=>{t.state==="installed"&&navigator.serviceWorker.controller&&(this.updateAvailable=!0,this.showUpdateNotification())})}),navigator.serviceWorker.controller&&(this.controller=navigator.serviceWorker.controller),navigator.serviceWorker.addEventListener("controllerchange",()=>{this.controller=navigator.serviceWorker.controller,window.location.reload()})}catch(e){console.error("Service Worker registration failed:",e)}})}setupMessageListener(){const e=new MessageChannel;navigator.serviceWorker.addEventListener("message",t=>{const{type:n,data:i}=t.data;switch(n){case"CACHE_UPDATED":console.log("Cache updated:",i);break;case"SYNC_COMPLETED":console.log("Background sync completed");break;default:console.log("Service Worker message:",n,i)}})}checkForUpdates(){return d(this,null,function*(){if(navigator.serviceWorker.controller)try{const e=new MessageChannel;e.port1.onmessage=t=>{const{version:n}=t.data;console.log("Service Worker version:",n)},navigator.serviceWorker.controller.postMessage({type:"GET_VERSION"},[e.port2])}catch(e){console.error("Failed to check for updates:",e)}})}showUpdateNotification(){NotificationUtils.showSuccess("ÂèëÁé∞Êñ∞ÁâàÊú¨ÔºåÁÇπÂáªÂà∑Êñ∞ÊåâÈíÆÊõ¥Êñ∞",8e3),this.addUpdateButton()}addUpdateButton(){if(DOM.find("#update-button"))return;const e=DOM.create("button",{id:"update-button",className:"update-button",innerHTML:"üîÑ Êõ¥Êñ∞",onclick:()=>this.applyUpdate()}),t=DOM.find("#kg-btn")||DOM.find("#wrap");t&&t.appendChild(e),this.addUpdateButtonStyles()}applyUpdate(){return d(this,null,function*(){if(this.updateAvailable)try{const e=new MessageChannel;navigator.serviceWorker.controller.postMessage({type:"SKIP_WAITING"},[e.port2]),NotificationUtils.showSuccess("Ê≠£Âú®Êõ¥Êñ∞Â∫îÁî®..."),this.showLoadingOverlay()}catch(e){console.error("Failed to apply update:",e),NotificationUtils.showError("Êõ¥Êñ∞Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Âà∑Êñ∞È°µÈù¢")}})}showLoadingOverlay(){const e=DOM.create("div",{id:"update-loading-overlay",className:"update-loading-overlay"},[DOM.create("div",{className:"update-loading-content"},[DOM.create("div",{className:"update-loading-spinner"}),DOM.create("p",{},["Ê≠£Âú®Êõ¥Êñ∞Â∫îÁî®..."])])]);document.body.appendChild(e)}addUpdateButtonStyles(){if(document.getElementById("update-button-styles"))return;const e=DOM.create("style",{id:"update-button-styles"});e.textContent=`
      .update-button {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 12px;
        cursor: pointer;
        margin-left: 10px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
      }

      .update-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
      }

      .update-loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 99999;
        backdrop-filter: blur(5px);
      }

      .update-loading-content {
        text-align: center;
        color: white;
      }

      .update-loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: update-spin 1s ease-in-out infinite;
        margin: 0 auto 20px;
      }

      @keyframes update-spin {
        to { transform: rotate(360deg); }
      }
    `,document.head.appendChild(e)}clearCache(){return d(this,null,function*(){if(!navigator.serviceWorker.controller){NotificationUtils.showError("Service WorkerÊú™ÊøÄÊ¥ª");return}try{const e=new MessageChannel;e.port1.onmessage=t=>{const{success:n}=t.data;n?NotificationUtils.showSuccess("ÁºìÂ≠òÂ∑≤Ê∏ÖÈô§"):NotificationUtils.showError("Ê∏ÖÈô§ÁºìÂ≠òÂ§±Ë¥•")},navigator.serviceWorker.controller.postMessage({type:"CLEAR_CACHE"},[e.port2])}catch(e){console.error("Failed to clear cache:",e),NotificationUtils.showError("Ê∏ÖÈô§ÁºìÂ≠òÂ§±Ë¥•")}})}getCacheStats(){return d(this,null,function*(){if(!navigator.serviceWorker.controller)return null;try{const e=new MessageChannel;return new Promise(t=>{e.port1.onmessage=n=>{t(n.data.stats)},navigator.serviceWorker.controller.postMessage({type:"GET_CACHE_STATS"},[e.port2])})}catch(e){return console.error("Failed to get cache stats:",e),null}})}preloadImages(e){return d(this,null,function*(){if(!(!navigator.serviceWorker.controller||!e.length))try{const t=new MessageChannel;t.port1.onmessage=n=>{const{success:i}=n.data;i&&console.log("Images preloaded successfully")},navigator.serviceWorker.controller.postMessage({type:"PRELOAD_IMAGES",data:{urls:e}},[t.port2])}catch(t){console.error("Failed to preload images:",t)}})}}window.ServiceWorkerManager=new ServiceWorkerManager;class ImageOptimizer{constructor(){this.supportsWebP=this.checkWebPSupport(),this.loadedImages=new Set,this.observerOptions={root:null,rootMargin:"50px",threshold:.1},this.init()}init(){this.initLazyLoading(),this.preloadCriticalImages(),this.setupImageErrorHandling()}checkWebPSupport(){return Promise.resolve(!1)}getOptimizedImageUrl(n){return d(this,arguments,function*(e,t={}){if(!e||e.startsWith("#"))return e;const{width:i,height:o,quality:c=80,format:a="auto"}=t;if(e.startsWith("http"))return e;let s=e;if(a==="auto"?(yield this.supportsWebP)&&this.canConvertToWebP(e)&&(s=e.replace(/\.(png|jpg|jpeg)$/i,".webp")):a==="webp"&&(s=e.replace(/\.(png|jpg|jpeg)$/i,".webp")),(i||o)&&this.supportsImageParams(s)){const l=new URLSearchParams;i&&l.append("w",i),o&&l.append("h",o),c!==80&&l.append("q",c);const p=s.includes("?")?"&":"?";s+=p+l.toString()}return s})}canConvertToWebP(e){return[".png",".jpg",".jpeg",".gif"].some(n=>e.toLowerCase().endsWith(n))}supportsImageParams(e){return!1}initLazyLoading(){if(!("IntersectionObserver"in window)){this.loadAllImages();return}const e=new IntersectionObserver(t=>{t.forEach(n=>{n.isIntersecting&&(this.loadImage(n.target),e.unobserve(n.target))})},this.observerOptions);DOM.findAll("img[data-src]").forEach(t=>{e.observe(t)})}loadImage(e){return d(this,null,function*(){const t=e.dataset.src;if(!(!t||this.loadedImages.has(t)))try{e.classList.add("image-loading");const n=yield this.getOptimizedImageUrl(t,{width:e.dataset.width,height:e.dataset.height}),i=new Image;i.onload=()=>{e.src=n,e.classList.remove("image-loading"),e.classList.add("image-loaded"),this.loadedImages.add(t),Animation.fadeIn(e,300)},i.onerror=()=>{n!==t?(e.src=t,e.classList.remove("image-loading"),e.classList.add("image-loaded"),this.loadedImages.add(t)):(e.classList.remove("image-loading"),e.classList.add("image-error"),this.handleImageError(e))},i.src=n}catch(n){console.error("Failed to load image:",t,n),e.classList.remove("image-loading"),e.classList.add("image-error"),this.handleImageError(e)}})}loadAllImages(){return d(this,null,function*(){const e=DOM.findAll("img[data-src]");for(const t of e)yield this.loadImage(t)})}preloadCriticalImages(){return d(this,null,function*(){const e=["img/google-official.svg","img/Bing.svg","img/baidu.svg"];for(const t of e)try{const n=yield this.getOptimizedImageUrl(t),i=document.createElement("link");i.rel="preload",i.as="image",i.href=n,document.head.appendChild(i)}catch(n){console.warn("Failed to preload critical image:",t)}})}handleImageError(e){e.classList.contains("fallback-applied")||(e.src="img/png/favicon.svg",e.classList.add("fallback-applied"),e.alt="ÂõæÊ†áÂä†ËΩΩÂ§±Ë¥•")}setupImageErrorHandling(){DOM.on(document,"error",e=>{e.target.tagName==="IMG"&&this.handleImageError(e.target)},!0)}createResponsiveImage(e,t,n={}){const{sizes:i="100vw",breakpoints:o=[480,768,1024],lazy:c=!0}=n,a=DOM.create("picture");if(o.length>0)for(let l=0;l<o.length;l++){const p=o[l],g=p,u=DOM.create("source",{media:`(min-width: ${p}px)`,sizes:i,type:"image/webp","data-srcset":`${e}?w=${g}&format=webp ${g}w`});a.appendChild(u)}const s=DOM.create("img",{"data-src":e,alt:t,loading:c?"lazy":"eager",decoding:"async"});return c&&s.classList.add("lazy-image"),a.appendChild(s),a}optimizeAppIcons(){return d(this,null,function*(){const e=DOM.findAll(".app-item img");for(const t of e)if(t.src&&!t.dataset.processed)try{const n=yield this.getOptimizedImageUrl(t.src,{width:64,height:64,quality:75});if(n!==t.src){const i=new Image;i.onload=()=>{t.src=n,t.dataset.processed="true"},i.src=n}else t.dataset.processed="true"}catch(n){console.warn("Failed to optimize app icon:",t.src),t.dataset.processed="true"}})}clearImageCache(){this.loadedImages.clear(),"caches"in window&&caches.keys().then(e=>Promise.all(e.filter(t=>t.includes("image")).map(t=>caches.delete(t))))}getImageStats(){const e=DOM.findAll("img").length,t=DOM.findAll("img.image-loaded").length,n=DOM.findAll("img.image-error").length,i=DOM.findAll("img.image-loading").length;return{total:e,loaded:t,error:n,loading:i,successRate:e>0?(t/e*100).toFixed(1):0}}}window.ImageOptimizer=new ImageOptimizer;
//# sourceMappingURL=app.js.map
