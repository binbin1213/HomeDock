<!DOCTYPE html>
<html>
  
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="renderer" content="webkit" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="stylesheet" type="text/css" href="css/style.css" />
    <link rel="stylesheet" type="text/css" href="css/responsive.css" />
    <link rel="stylesheet" type="text/css" href="css/drag-drop.css" />
    <link rel="stylesheet" type="text/css" href="css/image-optimizer.css" />

    <!-- å®‰å…¨ç­–ç•¥ -->
    <meta http-equiv="Content-Security-Policy"
          content="default-src 'self';
                   style-src 'self' 'unsafe-inline';
                   script-src 'self' 'unsafe-inline';
                   img-src 'self' data: https: blob:;
                   font-src 'self' data:;
                   connect-src 'self' https://www.bing.com data:;
                   base-uri 'self';
                   form-action 'self';">

    <!-- æ€§èƒ½ä¼˜åŒ– -->
    <meta name="theme-color" content="#1c1c1c">
    <meta name="color-scheme" content="dark light">

    <title>HomeDock</title>
  </head>
  
  <body>
    <div id="wrap">
      <div id="control-panel" class="control-panel">
        <div class="mode-switcher">
            <button class="switch-btn switch-btn-left active" data-mode="external">OFFICE</button>
            <button class="switch-btn switch-btn-right" data-mode="internal">HOME</button>
        </div>
        <button id="edit-toggle-btn" class="edit-btn-new">
            <span class="edit-icon">âœï¸</span>
            <span class="edit-text">ç¼–è¾‘</span>
        </button>
      </div>
      <div id="top">
        <div id="logo">
          <div class="type-js headline">
          	<h1 class="text-js">Welcome</h1>
          </div>
				</div>
			</div>
			<div id="logo-display">
				<img id="search-engine-logo" src="img/baidu.svg" alt="Search Engine" />
			</div>
			<div id="search-container" style="margin-top: 0;">
				<div id="search-box">
          <div id="search-engine-selector" class="search-engine-selector">
            <span id="current-engine-label">ç™¾åº¦</span>
            <svg id="dropdown-arrow" class="dropdown-arrow" width="12" height="12" viewBox="0 0 12 12" fill="none">
              <path d="M2 4L6 8L10 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <div id="search-input-wrapper">
				<input type="text" id="search-input" placeholder="è¾“å…¥æœç´¢å†…å®¹ï¼ŒæŒ‰å›è½¦é”®æœç´¢..." />
          </div>
          <button id="change-wallpaper-btn" type="button">æ¢ä¸€å¼ </button>
          <select id="search-engine" style="display: none;">
						<option value="google">Google</option>
						<option value="bing">Bing</option>
						<option value="baidu" selected>ç™¾åº¦</option>
					</select>
          <div id="search-engine-dropdown" class="search-engine-dropdown">
            <div class="dropdown-item" data-engine="google">
              <span>Google</span>
            </div>
            <div class="dropdown-item" data-engine="bing">
              <span>Bing</span>
            </div>
            <div class="dropdown-item" data-engine="baidu">
              <span>ç™¾åº¦</span>
            </div>
          </div>
				</div>
			</div>
			<div id="main">
			<!-- å¤–ç½‘è®¿é—®åœ°å€ -->
				<div id="app" class="app animated fadeInLeft">
					<ul id="external-apps">
						<!-- åº”ç”¨åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
					</ul>
					<button id="external-next-btn" class="page-arrow page-arrow-right">â€º</button>
				</div>
				<!-- å†…ç½‘ç½‘è®¿é—®åœ°å€ -->
				<div id="app1" class="app animated fadeInRight">
					<ul id="internal-apps">
						<!-- åº”ç”¨åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
					</ul>
					<button id="internal-next-btn" class="page-arrow page-arrow-right">â€º</button>
				</div>
				<div style="clear: both;"></div>
			</div>
		</div>
    <div id="footer">
      <div class="footer-contents">
        <div class="links">
          <a href="admin.html" id="admin-link">åå°ç®¡ç†</a>
        </div>
      </div>
    </div>
  </body>
  
  <!-- æ¨¡å—åŒ–è„šæœ¬åŠ è½½ -->
  <script>
    if (typeof window.NotificationUtils === 'undefined') {
      window.NotificationUtils = {
        showSuccess: function() { return null; },
        showError: function() { return null; },
        showWarning: function() { return null; },
        showInfo: function() { return null; },
        hideStatic: function() { return null; },
        clearStatic: function() { return null; },
        setSilentMode: function() {},
        isSilentMode: function() { return true; }
      };
    }
  </script>
  <script src="js/utils/helpers.js"></script>
  <script src="js/preset-icons.js"></script>
  <script src="js/utils/notification.js"></script>
  <script src="js/utils/service-worker.js"></script>
  <script src="js/utils/image-optimizer.js"></script>
  <script src="js/modules/config-manager.js"></script>
  <script src="js/modules/app-renderer.js"></script>
  <script src="js/modules/ui-controller.js"></script>
  <script src="js/modules/search-engine.js"></script>

  <!-- ä¸»åº”ç”¨åˆå§‹åŒ–è„šæœ¬ -->
  <script>
    /**
     * åº”ç”¨åˆå§‹åŒ–
     */
    document.addEventListener('DOMContentLoaded', async function() {
      try {
        console.log('ğŸš€ HomeDock åˆå§‹åŒ–å¼€å§‹...');

        // ç­‰å¾…æ¨¡å—åŠ è½½
        const requiredModules = [
          'Helpers',
          'NotificationUtils',
          'ConfigManager',
          'AppRenderer',
          'UIManager',
          'SearchEngine'
        ];

        console.log('â³ ç­‰å¾…æ¨¡å—åŠ è½½...');
        await waitForModules(requiredModules, 5000);
        console.log('âœ… æ‰€æœ‰æ¨¡å—åŠ è½½å®Œæˆ');

        // åŠ è½½é…ç½®
        console.log('âš™ï¸ æ­£åœ¨åŠ è½½é…ç½®...');
        if (typeof window.ConfigManager !== 'undefined') {
          await window.ConfigManager.loadConfigWithRetry();
          console.log('âœ… é…ç½®åŠ è½½å®Œæˆ');
        }

        // åˆå§‹åŒ–UIç»„ä»¶
        console.log('ğŸ¨ æ­£åœ¨åˆå§‹åŒ–UIç»„ä»¶...');
        if (typeof window.AppRenderer !== 'undefined') {
          window.AppRenderer.refresh();
        }

        if (typeof window.UIManager !== 'undefined') {
          window.UIManager.setupSearchFunction();
        }

        // è®¾ç½®å£çº¸æ›´æ¢æŒ‰é’®
        if (typeof window.Helpers !== 'undefined') {
          const changeWallpaperBtn = window.Helpers.DOM.find('#change-wallpaper-btn');
          if (changeWallpaperBtn && typeof window.SearchEngine !== 'undefined') {
            window.Helpers.DOM.on(changeWallpaperBtn, 'click', () => {
              window.SearchEngine.changeWallpaper();
            });
          }
        }

        // åº”ç”¨èƒŒæ™¯é…ç½®
        console.log('ğŸ–¼ï¸ æ­£åœ¨åº”ç”¨èƒŒæ™¯é…ç½®...');
        if (typeof window.SearchEngine !== 'undefined') {
          window.SearchEngine.applyBackgroundFromConfig();
        }

        // æ€§èƒ½ä¼˜åŒ–
        if (typeof window.SearchEngine !== 'undefined') {
          window.SearchEngine.optimizeBackgroundPerformance();
        }

        // é¢„åŠ è½½ä¸‹ä¸€å¼ å£çº¸
        setTimeout(() => {
          if (typeof window.SearchEngine !== 'undefined') {
            window.SearchEngine.preloadNextWallpaper();
          }
        }, 3000);

        console.log('ğŸ‰ HomeDock åˆå§‹åŒ–å®Œæˆ');

      } catch (error) {
        console.error('âŒ åº”ç”¨åˆå§‹åŒ–å¤±è´¥:', error);

        console.error('åº”ç”¨åˆå§‹åŒ–å¤±è´¥:', error.message);

        // æ˜¾ç¤ºç¼ºå¤±çš„æ¨¡å—
        const requiredModules = [
          'Helpers',
          'NotificationUtils',
          'ConfigManager',
          'AppRenderer',
          'UIManager',
          'SearchEngine'
        ];

        const missing = requiredModules.filter(name => typeof window[name] === 'undefined');
        if (missing.length > 0) {
          console.error('ç¼ºå¤±çš„æ¨¡å—:', missing);
        }
      }
    });

    /**
     * ç­‰å¾…æ¨¡å—åŠ è½½
     */
    function waitForModules(moduleNames, timeout = 10000) {
      return new Promise((resolve, reject) => {
        const startTime = Date.now();

        function checkModules() {
          const loaded = moduleNames.every(name => typeof window[name] !== 'undefined');

          if (loaded) {
            resolve();
            return;
          }

          if (Date.now() - startTime > timeout) {
            const missing = moduleNames.filter(name => typeof window[name] === 'undefined');
            reject(new Error(`ç­‰å¾…æ¨¡å—è¶…æ—¶: ${missing.join(', ')}`));
            return;
          }

          setTimeout(checkModules, 100);
        }

        checkModules();
      });
    }

    // å…¨å±€é”™è¯¯å¤„ç†
    window.addEventListener('error', function(e) {
      console.error('å…¨å±€é”™è¯¯:', e.error);
    });

    // æœªå¤„ç†çš„Promiseæ‹’ç»
    window.addEventListener('unhandledrejection', function(e) {
      console.error('æœªå¤„ç†çš„Promiseæ‹’ç»:', e.reason);
      e.preventDefault();
    });
  </script>

  <!-- ç¼–è¾‘åº”ç”¨æ¨¡æ€æ¡† -->
  <div id="editModal" class="edit-modal" style="display: none;">
    <div class="edit-modal-content">
      <span class="edit-modal-close">&times;</span>
      <h2>ç¼–è¾‘åº”ç”¨</h2>
      <form id="editForm">
        <div class="form-group">
          <label for="appName">åº”ç”¨åç§°ï¼š</label>
          <input type="text" id="appName" name="appName" required>
        </div>
        <div class="form-group">
          <label for="externalUrl">å¤–éƒ¨URLï¼š</label>
          <input type="url" id="externalUrl" name="externalUrl">
        </div>
        <div class="form-group">
          <label for="internalUrl">å†…éƒ¨URLï¼š</label>
          <input type="url" id="internalUrl" name="internalUrl">
        </div>
        <div class="form-group">
          <label for="iconPath">å›¾æ ‡è·¯å¾„ï¼š</label>
          <input type="text" id="iconPath" name="iconPath">
          <button type="button" id="iconPickerToggle" class="icon-picker-toggle">æµè§ˆé¢„è®¾å›¾æ ‡</button>
          <div id="iconPicker" class="icon-picker">
            <div class="icon-picker-grid" id="iconPickerGrid"></div>
          </div>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn-save">ä¿å­˜</button>
          <button type="button" class="btn-cancel">å–æ¶ˆ</button>
        </div>
      </form>
    </div>
  </div>

</html>
